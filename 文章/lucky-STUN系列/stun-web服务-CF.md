# 「LUCKY STUN穿透」使用Cloudflare的页面规则固定和隐藏网页端口

## 关于本教程


```
占位符
```

## 在STUN穿透环境中使用WEB服务

在之前的教程中我们已经通过lucky实现了较为安全的WEB访问[链接](https://www.bilibili.com/read/cv35702797/)  
但这些是建立在拥有**公网IP**的情况下（IPv4/IPv6）  


### 动态端口带来的麻烦

由于STUN穿透所获得的端口是动态的 即每次端口有一定的“生存时间”  
超过这个时间后端口号会再此次发生变化 变化的时间和变化后的端口号都是不确定的  
这也意味着要在STUN穿透后使用web服务需要**不停更的换端口** 是一件比较麻烦的事情  

在之前的教程中我们已经实现了 BT下载软件监听端口的自动更换 [链接](https://www.bilibili.com/read/cv31006420/)   
以及 Minecraft Java的服务器联机端口的固定 [链接](https://www.bilibili.com/read/cv31482590/)  

不过BT下载器依靠追踪器（tracker）和DHT网络自动化的获取 其他节点的端口和地址  
而 Minecraft Java 版依赖 **SRV记录** 来获取端口号  
在HTTP和浏览器不支持上述特性所以我们**无法使用这些方法**  

---

### “隐藏端口”和固定端口

固定端口 这个问题自然是针对STUN穿透的 其并不局限于WEB服务  
而“隐藏端口”这个概念更多由有公网的家宽用户提出  
这里简单的说明一下这两个概念  


* **固定端口**  
  这个概念非常好理解 即使总是用固定的端口号进行访问 无需更换端口号  

* **“隐藏端口”**  
  对与大部分协议协议来说所谓的 “隐藏端口” 其实是指的是不指定端口号  
  即使用默认端口进行连接  

  在浏览器中当不指定端口号的时候会使用HTTP/HTTPS的默认端口  
  HTTP中这个默认端口是80 而HTTPS是443  
 
所以能做到“隐藏端口” 其实也是做到了 固定端口  
对于在STUN穿透后使用web服务的用户来讲固定端口是一个迫切的需求  

而对有公网的家宽用户来说 “隐藏端口” 也是一个有吸引力的选择  
因为一般的家庭宽带是封堵 80和443端口的 （有些地方IPv6是不封的）  

---

### 可用的解决方法

所以在STUN穿透后使用WEB服务 
亟待解决的就是端口**不固定**和**不确定**的问题

#### 使用邮件进行通知端口变化

在稍早前的教程中我们实现了使用邮件来通知端口变化 [链接](https://www.bilibili.com/read/cv34705222/)  
有了邮件的通知我们只需要在访问的时候手动附加端口号即可

这一方案可用于任何使用TCP/UDP协议的程序  
但这样仍然比较麻烦 需要查看邮件内容并在访问时手动输入端口  

#### 使用HTTP重定向

好在HTTP有自己的特性 **重新定向**   
其可以改变端口和地址这为固定端口提供了可能  

* **使用 Cloudflare 进行重定向**
  
  cloudflare （下文简称CF）使用CF的重定向服务可以同时实现  
  “隐藏端口”和固定端口 当然这需要有域名托管在CF上
  **这也是本文将要介绍的方案**

* 使用免费FRP服务器转发端口
  
  与CF的重定向类似 但此方案是通过FRP映射出一个固定端口  
  此端口仅用于重定向（使用lucky）通入站的请求重定向到STUN穿透的端口  
  不然所有访问流量都会通过FRP服务器  
  
  这个方案的好处是可以使用免费的动态域名 理论上可以做到一分钱不花  
  可以轻松的实现固定端口但要实现 “隐藏端口”可能有些困难  
  要看免费FRP服务器80/443端口是否可用  

  
* 使用免费短链服务进行重定向

  其实与CF的重定向方案差不多 但是目前没有找到比较好的供应商  



## 使用Cloudflare的页面规则重定向URL以固定STUN穿透的网页端口

我们将使用CF页面规则来重定向URL以实现端口的固定和“隐藏”

此处需要两组域名 **重定向前的域名** 和 **重定向后的域名**

* 重定向前的域名  

  此域名开启CF代理 即IP解析到CF以便进行重定向处理  
  这也是我们需要在浏览器中输入的域名
  （例如`web.ie12.com`）


* 重定向后的域名   

 不开启CF代理 IP解析到真实的对外IP  
 这将是重定向后的访问的域名  
 (例如`web.stun.ie12.com)

当需要访问网页时 在浏览器中输入 `web.ie12.com`
此域名已经解析到CF的地址 于是CF的服务器会收到这个访问请求


 

工作流程图


### 设置DNS记录


 







